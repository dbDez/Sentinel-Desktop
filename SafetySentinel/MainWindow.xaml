<Window x:Class="SafetySentinel.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        Title="SENTINEL &#x2014; Personal Threat Intelligence"
        Width="1400" Height="900"
        MinWidth="1000" MinHeight="700"
        WindowStartupLocation="CenterScreen"
        Background="#0a0e17"
        Loaded="Window_Loaded"
        Icon="Assets/sentinel.ico">

    <Window.Resources>
        <!-- Color palette: CIA Operations Center dark theme -->
        <SolidColorBrush x:Key="PrimaryBg" Color="#0a0e17"/>
        <SolidColorBrush x:Key="SecondaryBg" Color="#111827"/>
        <SolidColorBrush x:Key="PanelBg" Color="#1a1f2e"/>
        <SolidColorBrush x:Key="BorderBrush" Color="#1e293b"/>
        <SolidColorBrush x:Key="TextPrimary" Color="#e5e7eb"/>
        <SolidColorBrush x:Key="TextSecondary" Color="#9ca3af"/>
        <SolidColorBrush x:Key="AccentGreenBrush" Color="#00ff88"/>
        <SolidColorBrush x:Key="AccentYellowBrush" Color="#fbbf24"/>
        <SolidColorBrush x:Key="AccentOrangeBrush" Color="#f97316"/>
        <SolidColorBrush x:Key="AccentBrush" Color="#ef4444"/>

        <!-- Default text styles -->
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource TextPrimary}"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
        </Style>
        <Style TargetType="TextBox">
            <Setter Property="Background" Value="#111827"/>
            <Setter Property="Foreground" Value="#e5e7eb"/>
            <Setter Property="BorderBrush" Value="#1e293b"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="CaretBrush" Value="#00ff88"/>
            <Setter Property="SelectionBrush" Value="#3300ff88"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="border" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="1"
                                CornerRadius="2" SnapsToDevicePixels="True">
                            <ScrollViewer x:Name="PART_ContentHost" Focusable="False"
                                          HorizontalScrollBarVisibility="Hidden"
                                          VerticalScrollBarVisibility="Hidden"
                                          Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsFocused" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="#00ff88"/>
                                <Setter TargetName="border" Property="Background" Value="#0d1520"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="BorderBrush" Value="#2a3a4e"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Button">
            <Setter Property="Background" Value="#1a1f2e"/>
            <Setter Property="Foreground" Value="#e5e7eb"/>
            <Setter Property="BorderBrush" Value="#1e293b"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="btnBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="btnBorder" Property="Background" Value="#2a3048"/>
                                <Setter TargetName="btnBorder" Property="BorderBrush" Value="#3a4a5e"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="btnBorder" Property="Background" Value="#0d1520"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="ComboBox">
            <Setter Property="Background" Value="#111827"/>
            <Setter Property="Foreground" Value="#e5e7eb"/>
            <Setter Property="BorderBrush" Value="#1e293b"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton x:Name="ToggleButton"
                                          Background="#111827" BorderBrush="#1e293b" BorderThickness="1"
                                          Foreground="#e5e7eb"
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                          Focusable="False" ClickMode="Press">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border x:Name="Border" Background="#111827" BorderBrush="#1e293b" BorderThickness="1" CornerRadius="2">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="20"/>
                                                </Grid.ColumnDefinitions>
                                                <Border Grid.Column="0" Background="Transparent"/>
                                                <Path Grid.Column="1" Data="M0,0 L4,4 L8,0" Stroke="#9ca3af" StrokeThickness="1.5"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Border" Property="BorderBrush" Value="#00ff88"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>
                            <ContentPresenter x:Name="ContentSite"
                                              Content="{TemplateBinding SelectionBoxItem}"
                                              ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                              IsHitTestVisible="False"
                                              Margin="8,4,24,4"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Left"/>
                            <Popup x:Name="PART_Popup" Placement="Bottom"
                                   IsOpen="{TemplateBinding IsDropDownOpen}"
                                   AllowsTransparency="True" Focusable="False"
                                   PopupAnimation="Slide">
                                <Grid x:Name="DropDown" MinWidth="{TemplateBinding ActualWidth}" MaxHeight="300" SnapsToDevicePixels="True">
                                    <Border x:Name="DropDownBorder" Background="#111827" BorderBrush="#1e293b" BorderThickness="1" CornerRadius="2"/>
                                    <ScrollViewer Margin="2" SnapsToDevicePixels="True">
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Contained"/>
                                    </ScrollViewer>
                                </Grid>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="ComboBoxItem">
            <Setter Property="Background" Value="#111827"/>
            <Setter Property="Foreground" Value="#e5e7eb"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border x:Name="Border" Background="#111827" Padding="{TemplateBinding Padding}">
                            <ContentPresenter/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#1a1f2e"/>
                                <Setter Property="Foreground" Value="#00ff88"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#1a1f2e"/>
                                <Setter Property="Foreground" Value="#00ff88"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="CheckBox">
            <Setter Property="Foreground" Value="#e5e7eb"/>
        </Style>
        <Style TargetType="GridViewColumnHeader">
            <Setter Property="Background" Value="#1a1f2e"/>
            <Setter Property="Foreground" Value="#9ca3af"/>
            <Setter Property="BorderBrush" Value="#1e293b"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Cursor" Value="Arrow"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GridViewColumnHeader">
                        <Grid>
                            <Border x:Name="HeaderBorder"
                                    Background="#1a1f2e"
                                    BorderBrush="#1e293b"
                                    BorderThickness="0,0,0,1"
                                    Padding="6,4">
                                <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center"
                                                  TextElement.Foreground="#9ca3af"
                                                  TextElement.FontSize="11"
                                                  TextElement.FontFamily="Segoe UI"
                                                  Margin="0,0,8,0"/>
                            </Border>
                            <!-- PART_HeaderGripper restores drag-to-resize column width -->
                            <Thumb x:Name="PART_HeaderGripper"
                                   HorizontalAlignment="Right"
                                   Width="8"
                                   Margin="0,0,-4,0"
                                   Cursor="SizeWE">
                                <Thumb.Template>
                                    <ControlTemplate TargetType="Thumb">
                                        <Border Background="Transparent"/>
                                    </ControlTemplate>
                                </Thumb.Template>
                            </Thumb>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="HeaderBorder" Property="Background" Value="#1e293b"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="HeaderBorder" Property="Background" Value="#1a1f2e"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <!-- Default ListViewItem style: uses ContentPresenter so DataTemplate/DisplayMemberPath ListViews work -->
        <Style TargetType="ListViewItem">
            <Setter Property="Foreground" Value="#e5e7eb"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="2,1"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="Transparent" BorderThickness="0"
                                Padding="{TemplateBinding Padding}"
                                SnapsToDevicePixels="True">
                            <ContentPresenter
                                Content="{TemplateBinding Content}"
                                ContentTemplate="{TemplateBinding ContentTemplate}"
                                HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#1e3a5e"/>
                                <Setter Property="Foreground" Value="#00ff88"/>
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                    <Condition Property="IsSelected" Value="False"/>
                                </MultiTrigger.Conditions>
                                <Setter TargetName="Bd" Property="Background" Value="#1a2535"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- GridView-specific ListViewItem style: uses GridViewRowPresenter for column rendering.
             Apply as ItemContainerStyle on any ListView that uses <ListView.View><GridView> -->
        <Style x:Key="GridViewItemStyle" TargetType="ListViewItem" BasedOn="{StaticResource {x:Type ListViewItem}}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="Transparent" BorderThickness="0"
                                Padding="{TemplateBinding Padding}"
                                SnapsToDevicePixels="True">
                            <GridViewRowPresenter
                                Columns="{Binding Path=View.Columns, RelativeSource={RelativeSource AncestorType={x:Type ListView}}}"
                                Content="{TemplateBinding Content}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#1e3a5e"/>
                                <Setter Property="Foreground" Value="#00ff88"/>
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                    <Condition Property="IsSelected" Value="False"/>
                                </MultiTrigger.Conditions>
                                <Setter TargetName="Bd" Property="Background" Value="#1a2535"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Label">
            <Setter Property="Foreground" Value="#9ca3af"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
        </Style>
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="#0a0e17"/>
            <Setter Property="BorderBrush" Value="#1e293b"/>
            <Setter Property="Foreground" Value="#e5e7eb"/>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Background" Value="#111827"/>
            <Setter Property="Foreground" Value="#9ca3af"/>
            <Setter Property="BorderBrush" Value="#1e293b"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
            <Setter Property="Padding" Value="10,4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="TabBorder" Background="#111827" BorderBrush="#1e293b"
                                BorderThickness="1,1,1,0" CornerRadius="4,4,0,0"
                                Padding="12,6" Margin="1,0">
                            <ContentPresenter x:Name="ContentSite"
                                              ContentSource="Header"
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="TabBorder" Property="Background" Value="#1a1f2e"/>
                                <Setter TargetName="TabBorder" Property="BorderBrush" Value="#00ff88"/>
                                <Setter Property="Foreground" Value="#00ff88"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="False">
                                <Setter TargetName="TabBorder" Property="Background" Value="#111827"/>
                                <Setter Property="Foreground" Value="#9ca3af"/>
                            </Trigger>
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsMouseOver" Value="True"/>
                                    <Condition Property="IsSelected" Value="False"/>
                                </MultiTrigger.Conditions>
                                <Setter TargetName="TabBorder" Property="Background" Value="#1a1f2e"/>
                                <Setter Property="Foreground" Value="#e5e7eb"/>
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Dark scrollbar styling -->
        <Style x:Key="DarkScrollBarThumb" TargetType="Thumb">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="IsTabStop" Value="False"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Thumb">
                        <Border Background="#4a5e78" CornerRadius="4"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="DarkScrollBarPageButton" TargetType="RepeatButton">
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="IsTabStop" Value="False"/>
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RepeatButton">
                        <Border Background="Transparent"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="ScrollBar">
            <Setter Property="Background" Value="#0d1117"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ScrollBar">
                        <Grid Background="#0d1117" Width="10">
                            <Track x:Name="PART_Track" IsDirectionReversed="True">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Style="{StaticResource DarkScrollBarPageButton}" Command="ScrollBar.PageUpCommand"/>
                                </Track.DecreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Style="{StaticResource DarkScrollBarThumb}" Margin="1"/>
                                </Track.Thumb>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Style="{StaticResource DarkScrollBarPageButton}" Command="ScrollBar.PageDownCommand"/>
                                </Track.IncreaseRepeatButton>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="Orientation" Value="Horizontal">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ScrollBar">
                                <Grid Background="#0d1117" Height="10">
                                    <Track x:Name="PART_Track" IsDirectionReversed="False">
                                        <Track.DecreaseRepeatButton>
                                            <RepeatButton Style="{StaticResource DarkScrollBarPageButton}" Command="ScrollBar.PageLeftCommand"/>
                                        </Track.DecreaseRepeatButton>
                                        <Track.Thumb>
                                            <Thumb Style="{StaticResource DarkScrollBarThumb}" Margin="1"/>
                                        </Track.Thumb>
                                        <Track.IncreaseRepeatButton>
                                            <RepeatButton Style="{StaticResource DarkScrollBarPageButton}" Command="ScrollBar.PageRightCommand"/>
                                        </Track.IncreaseRepeatButton>
                                    </Track>
                                </Grid>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="60"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="28"/>
        </Grid.RowDefinitions>

        <!-- ============ HEADER BAR ============ -->
        <Border Grid.Row="0" Background="#111827" BorderBrush="#1e293b" BorderThickness="0,0,0,1">
            <Grid Margin="16,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Logo -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,20,0">
                    <Image Source="Assets/Sentinel.png" Width="40" Height="40" Margin="0,0,10,0"
                           RenderOptions.BitmapScalingMode="HighQuality"/>
                    <TextBlock Text="SENTINEL" FontSize="20" FontWeight="Bold"
                               Foreground="#00ff88" VerticalAlignment="Center"
                               FontFamily="Consolas"/>
                </StackPanel>

                <!-- Threat Level Badge -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,16,0">
                    <TextBlock Text="Home Country: " Foreground="#9ca3af" FontSize="11" VerticalAlignment="Center"/>
                    <Border x:Name="ThreatLevelBadge" CornerRadius="4" Padding="10,4"
                            Background="{StaticResource AccentYellowBrush}">
                        <TextBlock x:Name="ThreatLevelText" Text="YELLOW" FontWeight="Bold"
                                   Foreground="#0a0e17" FontSize="13" FontFamily="Consolas"/>
                    </Border>
                </StackPanel>

                <!-- Hijack Risk Badge -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,16,0">
                    <TextBlock Text="Hijack Risk: " Foreground="#9ca3af" FontSize="11" VerticalAlignment="Center"/>
                    <Border x:Name="HijackRiskBadge" CornerRadius="4" Padding="8,3"
                            Background="{StaticResource AccentYellowBrush}">
                        <TextBlock x:Name="HijackRiskText" Text="MODERATE (45)" FontWeight="SemiBold"
                                   Foreground="#0a0e17" FontSize="11" FontFamily="Consolas"/>
                    </Border>
                </StackPanel>

                <!-- Country count + API credits (open space column) -->
                <Grid Grid.Column="3">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock x:Name="CountryCount" Grid.Column="0"
                               Text="loading..." Foreground="#9ca3af" FontSize="11"
                               VerticalAlignment="Center"/>

                    <!-- API Credits centred in remaining space -->
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                                Orientation="Vertical">
                        <TextBlock x:Name="ApiCreditsLabel" Text="INTELLIGENCE CREDITS"
                                   FontSize="9" Foreground="#4b5563" FontFamily="Consolas"
                                   HorizontalAlignment="Center"/>
                        <TextBlock x:Name="ApiCreditsAmount" Text="loading..."
                                   FontSize="12" FontWeight="SemiBold" Foreground="#9ca3af"
                                   FontFamily="Consolas" HorizontalAlignment="Center"/>
                        <Button x:Name="TopUpBtn" Content="Top Up Credits"
                                Click="TopupCredits_Click"
                                Background="Transparent" Foreground="#4b5563"
                                BorderBrush="#374151" BorderThickness="1"
                                Padding="6,1" FontSize="9" Cursor="Hand"
                                HorizontalAlignment="Center" Margin="0,2,0,0"/>
                    </StackPanel>
                </Grid>

                <!-- Scan Now button -->
                <Button Grid.Column="4" Content="&#x1F50D; Scan Now" Click="ScanNow_Click"
                        Background="#1a3a2a" Foreground="#00ff88" BorderBrush="#00ff88"
                        FontWeight="SemiBold" Margin="0,0,16,0" VerticalAlignment="Center"/>

                <!-- Clock -->
                <TextBlock x:Name="HeaderTime" Grid.Column="5" Text="00:00:00"
                           Foreground="#00ff88" FontSize="13" VerticalAlignment="Center"
                           FontFamily="Consolas"/>
            </Grid>
        </Border>

        <!-- ============ MAIN CONTENT &#x2014; TAB CONTROL ============ -->
        <TabControl x:Name="MainTabControl" Grid.Row="1" Background="#0a0e17" BorderBrush="#1e293b"
                    Padding="0" Margin="0" SelectionChanged="TabControl_SelectionChanged">

            <!-- ===== GLOBE TAB ===== -->
            <TabItem Header="&#x1F30D; Globe">
                <Grid Background="#0a0e17">
                    <wv2:WebView2 x:Name="GlobeWebView" DefaultBackgroundColor="#0a0e17"/>

                    <!-- Logo watermark â€” top right -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Top" HorizontalAlignment="Right"
                                Margin="0,12,16,0" IsHitTestVisible="False">
                        <Border Background="#111827" CornerRadius="8" Padding="8,6" Opacity="0.92"
                                BorderBrush="#1e293b" BorderThickness="1">
                            <StackPanel Orientation="Horizontal">
                                <Image Source="Assets/Sentinel.png" Width="32" Height="32" Margin="0,0,8,0"
                                       RenderOptions.BitmapScalingMode="HighQuality"/>
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="SENTINEL" FontSize="14" FontWeight="Bold"
                                               Foreground="#00ff88" FontFamily="Consolas"/>
                                    <TextBlock Text="Global Threat Monitor" FontSize="9"
                                               Foreground="#9ca3af" FontFamily="Consolas"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- ===== BRIEF TAB ===== -->
            <TabItem Header="&#x1F4CB; Brief">
                <Grid Background="#0a0e17">
                    <!-- Main brief content -->
                    <Grid Margin="16,16,16,16">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                            <Image Source="Assets/Sentinel.png" Width="28" Height="28" Margin="0,0,10,0"
                                   RenderOptions.BitmapScalingMode="HighQuality" VerticalAlignment="Center"/>
                            <TextBlock Text="DAILY INTELLIGENCE BRIEF" FontSize="16" FontWeight="Bold"
                                       Foreground="#00ff88" FontFamily="Consolas" VerticalAlignment="Center"/>
                            <TextBlock x:Name="BriefDateText" Text="" Foreground="#9ca3af"
                                       FontSize="12" VerticalAlignment="Center" Margin="20,0,0,0"/>
                        </StackPanel>

                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <TextBox x:Name="BriefContent" TextWrapping="Wrap" FontFamily="Consolas"
                                     FontSize="12" Foreground="#e5e7eb" Padding="12"
                                     Background="#111827" BorderThickness="0" IsReadOnly="True"
                                     AcceptsReturn="True" VerticalScrollBarVisibility="Disabled"
                                     Text="No intelligence brief generated yet.&#10;&#10;1. Fill in your Profile&#10;2. Add your Claude API key in Settings&#10;3. Click Scan Now"/>
                        </ScrollViewer>

                        <!-- Chat toggle button -->
                        <Button x:Name="BriefChatToggle" Grid.Row="2" Content="&#x1F4AC; Chat"
                                Click="BriefChatToggle_Click" Background="#1a3a2a" Foreground="#00ff88"
                                BorderBrush="#00ff88" HorizontalAlignment="Right" Margin="0,8,0,0"
                                Padding="16,6" FontWeight="SemiBold"/>
                    </Grid>

                    <!-- Sliding chat panel (overlays from bottom, resizable via drag) -->
                    <Border x:Name="BriefChatPanel" Background="#0d1117"
                            BorderBrush="#00ff88" BorderThickness="0,1,0,0"
                            VerticalAlignment="Bottom" Height="300"
                            MinHeight="120" MaxHeight="700"
                            RenderTransformOrigin="0.5,1">
                        <Border.RenderTransform>
                            <TranslateTransform x:Name="BriefChatTranslate" Y="300"/>
                        </Border.RenderTransform>
                        <Grid>
                            <!-- Drag-to-resize handle at the top -->
                            <Thumb x:Name="BriefChatResizeThumb" VerticalAlignment="Top" Height="6"
                                   Cursor="SizeNS" Opacity="0"
                                   DragDelta="BriefChatResizeThumb_DragDelta"/>
                            <Grid Margin="12,8,12,12">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <DockPanel Grid.Row="0" Margin="0,0,0,6">
                                    <Button Content="&#x2715; Close" Click="BriefChatClose_Click"
                                            DockPanel.Dock="Right" Background="#3a1a1a"
                                            Foreground="#ef4444" BorderBrush="#ef4444"
                                            Padding="10,3" FontSize="11"/>
                                    <TextBlock Text="SENTINEL CHAT" Foreground="#00ff88"
                                               FontWeight="Bold" FontFamily="Consolas" FontSize="13"
                                               VerticalAlignment="Center"/>
                                </DockPanel>

                                <RichTextBox x:Name="BriefChatMessages" Grid.Row="1"
                                             Background="#0a0e17" Foreground="#e5e7eb"
                                             BorderThickness="0" IsReadOnly="True"
                                             FontFamily="Consolas" FontSize="11"
                                             Padding="8" IsDocumentEnabled="True"
                                             VerticalScrollBarVisibility="Auto">
                                    <RichTextBox.Document>
                                        <FlowDocument PagePadding="0" LineStackingStrategy="BlockLineHeight">
                                        </FlowDocument>
                                    </RichTextBox.Document>
                                </RichTextBox>

                                <DockPanel Grid.Row="2" Margin="0,6,0,0">
                                    <Button x:Name="BriefChatSend" Content="Send"
                                            Click="BriefChatSend_Click" DockPanel.Dock="Right"
                                            Background="#1a3a2a" Foreground="#00ff88"
                                            BorderBrush="#00ff88" Padding="16,6" Margin="8,0,0,0"
                                            FontWeight="SemiBold"/>
                                    <Grid>
                                        <TextBlock x:Name="BriefChatPlaceholder"
                                                   Text="Type your question about the security brief here..."
                                                   Foreground="#4a5568" FontFamily="Consolas" FontSize="12"
                                                   VerticalAlignment="Center" Margin="8,0,0,0"
                                                   IsHitTestVisible="False"/>
                                        <TextBox x:Name="BriefChatInput" Background="#0a0e17"
                                                 Foreground="#e5e7eb" BorderBrush="#00ff88"
                                                 FontFamily="Consolas" FontSize="12"
                                                 KeyDown="BriefChatInput_KeyDown"
                                                 GotFocus="ChatInput_GotFocus"
                                                 LostFocus="ChatInput_LostFocus"
                                                 TextChanged="ChatInput_TextChanged"/>
                                    </Grid>
                                </DockPanel>
                            </Grid>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>

            <!-- ===== HISTORY TAB ===== -->
            <TabItem Header="&#x1F4DC; History">
                <Grid Background="#0a0e17">
                    <!-- Main history content -->
                    <Grid Margin="16">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="280"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Background="#111827" CornerRadius="4" Margin="0,0,8,0" Padding="8">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                        <Image Source="Assets/Sentinel.png" Width="20" Height="20" Margin="0,0,6,0"
                                               RenderOptions.BitmapScalingMode="HighQuality" VerticalAlignment="Center"/>
                                        <TextBlock Text="BRIEF HISTORY" FontWeight="Bold" Foreground="#00ff88"
                                                   FontFamily="Consolas" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <ListBox x:Name="BriefHistoryList" Grid.Row="1"
                                             Background="#111827" Foreground="#e5e7eb" BorderThickness="0"
                                             SelectionChanged="BriefHistory_SelectionChanged"
                                             DisplayMemberPath="DisplayText"/>
                                </Grid>
                            </Border>

                            <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                                <TextBox x:Name="HistoryBriefContent" TextWrapping="Wrap" FontFamily="Consolas"
                                         FontSize="12" Foreground="#e5e7eb" Padding="12" Background="#111827"
                                         BorderThickness="0" IsReadOnly="True" AcceptsReturn="True"
                                         VerticalScrollBarVisibility="Disabled"
                                         Text="Select a brief from the list to view."/>
                            </ScrollViewer>
                        </Grid>

                        <!-- Chat toggle button -->
                        <Button x:Name="HistoryChatToggle" Grid.Row="1" Content="&#x1F4AC; Chat"
                                Click="HistoryChatToggle_Click" Background="#1a3a2a" Foreground="#00ff88"
                                BorderBrush="#00ff88" HorizontalAlignment="Right" Margin="0,8,0,0"
                                Padding="16,6" FontWeight="SemiBold"/>
                    </Grid>

                    <!-- Sliding chat panel (overlays from bottom, resizable via drag) -->
                    <Border x:Name="HistoryChatPanel" Background="#0d1117"
                            BorderBrush="#00ff88" BorderThickness="0,1,0,0"
                            VerticalAlignment="Bottom" Height="300"
                            MinHeight="120" MaxHeight="700"
                            RenderTransformOrigin="0.5,1">
                        <Border.RenderTransform>
                            <TranslateTransform x:Name="HistoryChatTranslate" Y="300"/>
                        </Border.RenderTransform>
                        <Grid>
                            <!-- Drag-to-resize handle at the top -->
                            <Thumb x:Name="HistoryChatResizeThumb" VerticalAlignment="Top" Height="6"
                                   Cursor="SizeNS" Opacity="0"
                                   DragDelta="HistoryChatResizeThumb_DragDelta"/>
                            <Grid Margin="12,8,12,12">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <DockPanel Grid.Row="0" Margin="0,0,0,6">
                                    <Button Content="&#x2715; Close" Click="HistoryChatClose_Click"
                                            DockPanel.Dock="Right" Background="#3a1a1a"
                                            Foreground="#ef4444" BorderBrush="#ef4444"
                                            Padding="10,3" FontSize="11"/>
                                    <TextBlock Text="HISTORY QUERY" Foreground="#00ff88"
                                               FontWeight="Bold" FontFamily="Consolas" FontSize="13"
                                               VerticalAlignment="Center"/>
                                </DockPanel>

                                <RichTextBox x:Name="HistoryChatMessages" Grid.Row="1"
                                             Background="#0a0e17" Foreground="#e5e7eb"
                                             BorderThickness="0" IsReadOnly="True"
                                             FontFamily="Consolas" FontSize="11"
                                             Padding="8" IsDocumentEnabled="True"
                                             VerticalScrollBarVisibility="Auto">
                                    <RichTextBox.Document>
                                        <FlowDocument PagePadding="0" LineStackingStrategy="BlockLineHeight">
                                        </FlowDocument>
                                    </RichTextBox.Document>
                                </RichTextBox>

                                <DockPanel Grid.Row="2" Margin="0,6,0,0">
                                    <Button x:Name="HistoryChatSend" Content="Send"
                                            Click="HistoryChatSend_Click" DockPanel.Dock="Right"
                                            Background="#1a3a2a" Foreground="#00ff88"
                                            BorderBrush="#00ff88" Padding="16,6" Margin="8,0,0,0"
                                            FontWeight="SemiBold"/>
                                    <Grid>
                                        <TextBlock x:Name="HistoryChatPlaceholder"
                                                   Text="Type your question about brief history here..."
                                                   Foreground="#4a5568" FontFamily="Consolas" FontSize="12"
                                                   VerticalAlignment="Center" Margin="8,0,0,0"
                                                   IsHitTestVisible="False"/>
                                        <TextBox x:Name="HistoryChatInput" Background="#0a0e17"
                                                 Foreground="#e5e7eb" BorderBrush="#00ff88"
                                                 FontFamily="Consolas" FontSize="12"
                                                 KeyDown="HistoryChatInput_KeyDown"
                                                 GotFocus="ChatInput_GotFocus"
                                                 LostFocus="ChatInput_LostFocus"
                                                 TextChanged="ChatInput_TextChanged"/>
                                    </Grid>
                                </DockPanel>
                            </Grid>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>

            <!-- ===== ALERTS TAB ===== -->
            <TabItem Header="&#x1F514; Alerts">
                <Grid Background="#0a0e17" Margin="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <Image Source="Assets/Sentinel.png" Width="28" Height="28" Margin="0,0,10,0"
                               RenderOptions.BitmapScalingMode="HighQuality" VerticalAlignment="Center"/>
                        <TextBlock Text="ALERT CATEGORIES" FontSize="16" FontWeight="Bold"
                                   Foreground="#00ff88" FontFamily="Consolas" VerticalAlignment="Center"/>
                        <TextBlock x:Name="AlertCountText" Text="" Foreground="#9ca3af"
                                   FontSize="12" VerticalAlignment="Center" Margin="20,0,0,0"/>
                    </StackPanel>

                    <ListView x:Name="AlertCategoriesList" Grid.Row="1"
                              Background="#0a0e17" BorderThickness="0" Foreground="#e5e7eb">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="30"/>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="200"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="60"/>
                                        <ColumnDefinition Width="80"/>
                                    </Grid.ColumnDefinitions>
                                    <CheckBox Grid.Column="0" IsChecked="{Binding Enabled}"
                                              Click="AlertToggle_Click" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Domain}" Foreground="#fbbf24"
                                               FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="2" Text="{Binding Category}" Foreground="#e5e7eb"
                                               FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="3" Text="{Binding Description}" Foreground="#9ca3af"
                                               FontSize="11" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Grid.Column="4" Text="{Binding SeverityWeight}" Foreground="#f97316"
                                               FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    <TextBlock Grid.Column="5" Text="{Binding ScanFrequency}" Foreground="#9ca3af"
                                               FontSize="10" VerticalAlignment="Center"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <!-- Personal Threat Alerts -->
                    <Border Grid.Row="2" Background="#111827" CornerRadius="4"
                            Padding="12" Margin="0,12,0,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="PERSONAL THREAT ALERTS"
                                       Foreground="#fbbf24" FontWeight="Bold"
                                       FontFamily="Consolas" Margin="0,0,0,8"/>

                            <DockPanel Grid.Row="1" Margin="0,0,0,8">
                                <Button Content="Remove" Click="RemovePersonalAlert_Click"
                                        DockPanel.Dock="Right" Background="#3a1a1a"
                                        Foreground="#ef4444" BorderBrush="#ef4444"
                                        Padding="12,4" Margin="8,0,0,0"/>
                                <Button Content="+ Add" Click="AddPersonalAlert_Click"
                                        DockPanel.Dock="Right" Background="#1a3a2a"
                                        Foreground="#00ff88" BorderBrush="#00ff88"
                                        Padding="12,4" Margin="8,0,0,0"/>
                                <TextBox x:Name="PersonalAlertInput"
                                         Background="#0a0e17" Foreground="#e5e7eb"
                                         BorderBrush="#1e293b"/>
                            </DockPanel>

                            <ListBox x:Name="PersonalAlertsList" Grid.Row="2"
                                     Background="#111827" Foreground="#e5e7eb"
                                     BorderThickness="0" MaxHeight="120"
                                     DisplayMemberPath="DisplayText"/>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>

            <!-- ===== WATCHLIST TAB ===== -->
            <TabItem Header="&#x1F441; Watchlist">
                <Grid Background="#0a0e17" Margin="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header + Smart Select -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                        <Image Source="Assets/Sentinel.png" Width="28" Height="28" Margin="0,0,10,0"
                               RenderOptions.BitmapScalingMode="HighQuality" VerticalAlignment="Center"/>
                        <TextBlock Text="COUNTRY WATCHLIST" FontSize="16" FontWeight="Bold"
                                   Foreground="#00ff88" FontFamily="Consolas" VerticalAlignment="Center"/>
                        <Button x:Name="SmartSelectBtn" Content="&#x26A1; Smart Select"
                                Margin="16,0,0,0" Click="SmartSelect_Click"
                                Background="#1a1a3a" Foreground="#a78bfa" BorderBrush="#a78bfa"
                                Padding="10,4" VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Continent quick-select -->
                    <Border Grid.Row="1" Background="#111827" BorderBrush="#1e293b" BorderThickness="1"
                            CornerRadius="4" Padding="8,6" Margin="0,0,0,8">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="WATCH CONTINENT:" Foreground="#9ca3af" FontSize="11"
                                       FontFamily="Consolas" VerticalAlignment="Center" Margin="0,0,10,0"/>
                            <CheckBox x:Name="CbAfrica" Content="Africa" Margin="0,0,10,0" IsThreeState="True"
                                      Checked="ContinentChecked" Unchecked="ContinentUnchecked"
                                      Indeterminate="ContinentIndeterminate" Tag="Africa"/>
                            <CheckBox x:Name="CbAsia" Content="Asia" Margin="0,0,10,0" IsThreeState="True"
                                      Checked="ContinentChecked" Unchecked="ContinentUnchecked"
                                      Indeterminate="ContinentIndeterminate" Tag="Asia"/>
                            <CheckBox x:Name="CbEurope" Content="Europe" Margin="0,0,10,0" IsThreeState="True"
                                      Checked="ContinentChecked" Unchecked="ContinentUnchecked"
                                      Indeterminate="ContinentIndeterminate" Tag="Europe"/>
                            <CheckBox x:Name="CbNorthAmerica" Content="N. America" Margin="0,0,10,0" IsThreeState="True"
                                      Checked="ContinentChecked" Unchecked="ContinentUnchecked"
                                      Indeterminate="ContinentIndeterminate" Tag="North America"/>
                            <CheckBox x:Name="CbSouthAmerica" Content="S. America" Margin="0,0,10,0" IsThreeState="True"
                                      Checked="ContinentChecked" Unchecked="ContinentUnchecked"
                                      Indeterminate="ContinentIndeterminate" Tag="South America"/>
                            <CheckBox x:Name="CbOceania" Content="Oceania" IsThreeState="True"
                                      Checked="ContinentChecked" Unchecked="ContinentUnchecked"
                                      Indeterminate="ContinentIndeterminate" Tag="Oceania"/>
                        </StackPanel>
                    </Border>

                    <!-- Split panels -->
                    <Grid Grid.Row="2">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" MinHeight="80"/>
                            <RowDefinition Height="5"/>
                            <RowDefinition Height="2*" MinHeight="80"/>
                        </Grid.RowDefinitions>

                        <!-- Watchlist -->
                        <Grid Grid.Row="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Margin="0,0,0,4" FontSize="11"
                                       FontFamily="Consolas" FontWeight="SemiBold" Foreground="#00ff88">
                                <Run Text="&#x25B2; WATCHLIST"/>
                                <Run Text=" â€” included in briefs. Right-click to edit or move." Foreground="#6b7280"/>
                            </TextBlock>
                            <ListView x:Name="WatchlistView" Grid.Row="1" Background="#111827"
                                      Foreground="#e5e7eb" BorderThickness="0"
                                      ItemContainerStyle="{StaticResource GridViewItemStyle}"
                                      MouseDoubleClick="WatchlistView_DoubleClick">
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header="Country" Width="175" DisplayMemberBinding="{Binding CountryName}"/>
                                        <GridViewColumn Header="Code" Width="45" DisplayMemberBinding="{Binding CountryCode}"/>
                                        <GridViewColumn Header="Cities" Width="150" DisplayMemberBinding="{Binding City}"/>
                                        <GridViewColumn Header="State/Province" Width="120" DisplayMemberBinding="{Binding StateProvince}"/>
                                        <GridViewColumn Header="Reason" Width="175" DisplayMemberBinding="{Binding Reason}"/>
                                        <GridViewColumn Header="Exit Plan" Width="70" DisplayMemberBinding="{Binding ExitPlanLabel}"/>
                                    </GridView>
                                </ListView.View>
                                <ListView.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Add Cities..." Click="WatchCtx_AddCities"/>
                                        <MenuItem Header="Add State/Province..." Click="WatchCtx_AddState"/>
                                        <MenuItem Header="Add Watchlist Reason..." Click="WatchCtx_AddReason"/>
                                        <Separator/>
                                        <MenuItem Header="Toggle Exit Plan Destination" Click="WatchCtx_ToggleExitPlan"/>
                                        <Separator/>
                                        <MenuItem Header="Move to Excluded List" Click="WatchCtx_MoveToExcluded"/>
                                    </ContextMenu>
                                </ListView.ContextMenu>
                            </ListView>
                        </Grid>

                        <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch"
                                      Background="#1e293b" VerticalAlignment="Center" Cursor="SizeNS"/>

                        <!-- Excluded countries -->
                        <Grid Grid.Row="2">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Margin="0,4,0,4" FontSize="11"
                                       FontFamily="Consolas" FontWeight="SemiBold" Foreground="#fbbf24">
                                <Run Text="&#x25BC; EXCLUDED"/>
                                <Run Text=" â€” omitted from briefs. Right-click to add to watchlist." Foreground="#6b7280"/>
                            </TextBlock>
                            <ListView x:Name="ExclusionView" Grid.Row="1" Background="#111827"
                                      Foreground="#e5e7eb" BorderThickness="0"
                                      ItemContainerStyle="{StaticResource GridViewItemStyle}"
                                      MouseDoubleClick="ExclusionView_DoubleClick">
                                <ListView.View>
                                    <GridView>
                                        <GridViewColumn Header="Country" Width="175" DisplayMemberBinding="{Binding CountryName}"/>
                                        <GridViewColumn Header="Code" Width="45" DisplayMemberBinding="{Binding CountryCode}"/>
                                        <GridViewColumn Header="Cities" Width="150" DisplayMemberBinding="{Binding City}"/>
                                        <GridViewColumn Header="State/Province" Width="120" DisplayMemberBinding="{Binding StateProvince}"/>
                                        <GridViewColumn Header="Reason" Width="220" DisplayMemberBinding="{Binding Reason}"/>
                                    </GridView>
                                </ListView.View>
                                <ListView.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Add to Watchlist" Click="ExclCtx_AddToWatchlist"/>
                                    </ContextMenu>
                                </ListView.ContextMenu>
                            </ListView>
                        </Grid>
                    </Grid>
                </Grid>
            </TabItem>

            <!-- ===== EXIT PLANS TAB ===== -->
            <TabItem Header="&#x1F6AA; Exit Plans">
                <Grid Background="#0a0e17" Margin="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <Image Source="Assets/Sentinel.png" Width="28" Height="28" Margin="0,0,10,0"
                               RenderOptions.BitmapScalingMode="HighQuality" VerticalAlignment="Center"/>
                        <TextBlock Text="EXIT PLANS" FontSize="16" FontWeight="Bold"
                                   Foreground="#00ff88" FontFamily="Consolas" Margin="0,0,16,0"
                                   VerticalAlignment="Center"/>
                        <TextBlock x:Name="ExitPlanProgress" Text="" Foreground="#fbbf24"
                                   VerticalAlignment="Center" Margin="0,0,16,0" FontWeight="SemiBold"/>
                        <Button Content="&#x1F4CB; Copy Plan" Click="CopyExitPlan_Click"/>
                    </StackPanel>

                    <!-- Left + splitter + right -->
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="280" MinWidth="150"/>
                            <ColumnDefinition Width="5"/>
                            <ColumnDefinition Width="*" MinWidth="200"/>
                        </Grid.ColumnDefinitions>

                        <!-- Left panel: exit destinations + auto-suggested -->
                        <Grid Grid.Column="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <!-- Destinations list â€” flexible top half -->
                                <RowDefinition Height="*" MinHeight="80"/>
                                <!-- Splitter: only moves the boundary between Row 1 and Row 3 -->
                                <RowDefinition Height="5"/>
                                <!-- Auto-routes block â€” flexible bottom half, header always visible -->
                                <RowDefinition Height="*" MinHeight="100"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="MY EXIT DESTINATIONS" Foreground="#00ff88"
                                       FontFamily="Consolas" FontSize="11" FontWeight="SemiBold" Margin="0,0,0,4"/>
                            <ListView x:Name="ExitPlanCountriesView" Grid.Row="1"
                                      Background="#111827" BorderThickness="0" Foreground="#e5e7eb"
                                      DisplayMemberPath="DisplayText"
                                      SelectionChanged="ExitPlanCountry_Selected"/>
                            <GridSplitter Grid.Row="2" Height="5" HorizontalAlignment="Stretch"
                                          Background="#1e293b" VerticalAlignment="Center" Cursor="SizeNS"
                                          ResizeBehavior="PreviousAndNext"/>

                            <!-- Auto-routes section nested in one * row so splitter only moves its top edge -->
                            <Grid Grid.Row="3">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0" Text="AUTO-SUGGESTED ROUTES" Foreground="#fbbf24"
                                           FontFamily="Consolas" FontSize="11" FontWeight="SemiBold" Margin="0,4,0,4"/>
                                <TextBlock Grid.Row="1" x:Name="AutoExitPlaceholder" TextWrapping="Wrap"
                                           Text="To see auto-suggested exit routes, enter a valid address in your Profile and press Scan."
                                           Foreground="#4a5568" FontSize="10" Margin="0,0,0,4"/>
                                <ListView x:Name="AutoExitView" Grid.Row="2"
                                          Background="#111827" BorderThickness="0" Foreground="#9ca3af"
                                          DisplayMemberPath="DisplayText"/>
                            </Grid>
                        </Grid>

                        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center"
                                      Background="#1e293b" VerticalAlignment="Stretch" Cursor="SizeWE"/>

                        <!-- Right panel: tasks for selected destination -->
                        <Grid Grid.Column="2">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock x:Name="ExitPlanTitle" Grid.Row="0"
                                       Text="&#x2190; Select a destination"
                                       Foreground="#9ca3af" FontFamily="Consolas" FontSize="12" Margin="8,0,0,8"/>
                            <ListView x:Name="ExitPlanList" Grid.Row="1"
                                      Background="#0a0e17" BorderThickness="0" Foreground="#e5e7eb" Margin="8,0,0,0">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,3">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="30"/>
                                                <ColumnDefinition Width="120"/>
                                                <ColumnDefinition Width="200"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <CheckBox Grid.Column="0" IsChecked="{Binding Completed}"
                                                      Click="ExitPlanCheck_Click" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Category}" Foreground="#fbbf24"
                                                       FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="2" Text="{Binding TaskTitle}" Foreground="#e5e7eb"
                                                       FontWeight="SemiBold" VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="3" Text="{Binding TaskDescription}" Foreground="#9ca3af"
                                                       FontSize="11" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </Grid>
                    </Grid>
                </Grid>
            </TabItem>

            <!-- ===== PROFILE TAB ===== -->
            <TabItem Header="&#x1F464; Profile">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Background="#0a0e17">
                    <StackPanel Margin="16">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                            <Image Source="Assets/Sentinel.png" Width="28" Height="28" Margin="0,0,10,0"
                                   RenderOptions.BitmapScalingMode="HighQuality" VerticalAlignment="Center"/>
                            <TextBlock Text="HVR PROFILE" FontSize="16" FontWeight="Bold"
                                       Foreground="#00ff88" FontFamily="Consolas" VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Values, Health, Skills â€” shown first so they're immediately visible -->
                        <TextBlock Text="VALUES &amp; LIFESTYLE" Foreground="#fbbf24" FontWeight="Bold" Margin="0,0,0,8"/>
                        <Label Content="Core Values"/>
                        <TextBox x:Name="ProfileValues" TextWrapping="Wrap" AcceptsReturn="True" Height="50"/>
                        <Label Content="Health Approach"/>
                        <TextBox x:Name="ProfileHealth" TextWrapping="Wrap" AcceptsReturn="True" Height="50"/>
                        <Label Content="Skills"/>
                        <TextBox x:Name="ProfileSkills" TextWrapping="Wrap" AcceptsReturn="True" Height="50"/>

                        <!-- Personal Info -->
                        <TextBlock Text="PERSONAL INFORMATION" Foreground="#fbbf24" FontWeight="Bold" Margin="0,16,0,8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="300"/>
                                <ColumnDefinition Width="40"/>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="300"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="36"/>
                                <RowDefinition Height="36"/>
                                <RowDefinition Height="36"/>
                                <RowDefinition Height="36"/>
                                <RowDefinition Height="36"/>
                                <RowDefinition Height="36"/>
                                <RowDefinition Height="36"/>
                                <RowDefinition Height="36"/>
                            </Grid.RowDefinitions>

                            <Label Content="Full Name" Grid.Row="0" Grid.Column="0"/>
                            <TextBox x:Name="ProfileName" Grid.Row="0" Grid.Column="1"/>
                            <Label Content="ID Number" Grid.Row="0" Grid.Column="3"/>
                            <TextBox x:Name="ProfileIdNumber" Grid.Row="0" Grid.Column="4"/>

                            <Label Content="Age" Grid.Row="1" Grid.Column="0"/>
                            <TextBox x:Name="ProfileAge" Grid.Row="1" Grid.Column="1" Width="80" HorizontalAlignment="Left"/>
                            <Label Content="Gender" Grid.Row="1" Grid.Column="3"/>
                            <ComboBox x:Name="ProfileGender" Grid.Row="1" Grid.Column="4" Width="120" HorizontalAlignment="Left">
                                <ComboBoxItem Content="Male"/>
                                <ComboBoxItem Content="Female"/>
                                <ComboBoxItem Content="Other"/>
                            </ComboBox>

                            <Label Content="Ethnicity" Grid.Row="2" Grid.Column="0"/>
                            <TextBox x:Name="ProfileEthnicity" Grid.Row="2" Grid.Column="1"/>
                            <Label Content="Immigration" Grid.Row="2" Grid.Column="3"/>
                            <TextBox x:Name="ProfileImmigration" Grid.Row="2" Grid.Column="4"/>

                            <!-- Address fields -->
                            <Label Content="Street Address" Grid.Row="3" Grid.Column="0"/>
                            <TextBox x:Name="ProfileStreetAddress" Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="4"/>

                            <Label Content="Suburb" Grid.Row="4" Grid.Column="0"/>
                            <TextBox x:Name="ProfileSuburb" Grid.Row="4" Grid.Column="1"/>
                            <Label Content="City" Grid.Row="4" Grid.Column="3"/>
                            <TextBox x:Name="ProfileCity" Grid.Row="4" Grid.Column="4"/>

                            <Label Content="Country" Grid.Row="5" Grid.Column="0"/>
                            <TextBox x:Name="ProfileCountry" Grid.Row="5" Grid.Column="1"/>
                            <Label Content="Postal Code" Grid.Row="5" Grid.Column="3"/>
                            <TextBox x:Name="ProfilePostalCode" Grid.Row="5" Grid.Column="4" Width="150" HorizontalAlignment="Left"/>

                            <Label Content="Latitude" Grid.Row="6" Grid.Column="0"/>
                            <TextBox x:Name="ProfileLat" Grid.Row="6" Grid.Column="1" Width="150" HorizontalAlignment="Left"
                                     IsReadOnly="True" Foreground="#9ca3af"/>
                            <Label Content="Longitude" Grid.Row="6" Grid.Column="3"/>
                            <TextBox x:Name="ProfileLon" Grid.Row="6" Grid.Column="4" Width="150" HorizontalAlignment="Left"
                                     IsReadOnly="True" Foreground="#9ca3af"/>

                            <Label Content="Vehicle Type" Grid.Row="7" Grid.Column="0"/>
                            <ComboBox x:Name="ProfileVehicleType" Grid.Row="7" Grid.Column="1" Width="120" HorizontalAlignment="Left">
                                <ComboBoxItem Content="Sedan"/>
                                <ComboBoxItem Content="SUV"/>
                                <ComboBoxItem Content="Hatchback"/>
                                <ComboBoxItem Content="Bakkie"/>
                                <ComboBoxItem Content="Luxury"/>
                                <ComboBoxItem Content="4x4"/>
                            </ComboBox>
                            <Label Content="Make / Model" Grid.Row="7" Grid.Column="3"/>
                            <TextBox x:Name="ProfileVehicleMakeModel" Grid.Row="7" Grid.Column="4"/>
                        </Grid>

                        <Button Content="&#x1F4BE; Save Profile" Click="SaveProfile_Click" Margin="0,16,0,0"
                                Background="#1a3a2a" Foreground="#00ff88" BorderBrush="#00ff88"
                                FontWeight="Bold" HorizontalAlignment="Left" Padding="20,8"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- ===== SETTINGS TAB ===== -->
            <TabItem Header="&#x2699; Settings">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Background="#0a0e17">
                    <StackPanel Margin="16" MaxWidth="700" HorizontalAlignment="Left">
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                            <Image Source="Assets/Sentinel.png" Width="28" Height="28" Margin="0,0,10,0"
                                   RenderOptions.BitmapScalingMode="HighQuality" VerticalAlignment="Center"/>
                            <TextBlock Text="SETTINGS" FontSize="16" FontWeight="Bold"
                                       Foreground="#00ff88" FontFamily="Consolas" VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- API Configuration -->
                        <TextBlock Text="API CONFIGURATION" Foreground="#fbbf24" FontWeight="Bold" Margin="0,0,0,8"/>
                        <Label Content="Claude API Key"/>
                        <PasswordBox x:Name="SettingsApiKey" Background="#111827" Foreground="#e5e7eb"
                                     BorderBrush="#1e293b" Padding="6,4"/>
                        <Label Content="Claude Model"/>
                        <ComboBox x:Name="SettingsModel" Width="350" HorizontalAlignment="Left">
                            <ComboBoxItem Content="claude-opus-4-6"/>
                            <ComboBoxItem Content="claude-sonnet-4-5-20250929"/>
                            <ComboBoxItem Content="claude-opus-4-5-20251101"/>
                            <ComboBoxItem Content="claude-haiku-4-5-20251001"/>
                            <ComboBoxItem Content="claude-sonnet-4-20250514"/>
                            <ComboBoxItem Content="claude-opus-4-20250514"/>
                        </ComboBox>
                        <Label Content="Google Maps API Key"/>
                        <TextBox x:Name="SettingsGoogleKey"/>
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0" VerticalAlignment="Center">
                            <Label Content="Credit Balance ($)" VerticalAlignment="Center" Padding="0,0,6,0"/>
                            <TextBox x:Name="SettingsApiMonthlyBudget" Width="80" Text="0.00" VerticalAlignment="Center"/>
                            <TextBlock Text="  Enter your current Anthropic balance â€” spend tracked from save date"
                                       Foreground="#6b7280" FontSize="10" VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Scan Configuration -->
                        <TextBlock Text="SCAN CONFIGURATION" Foreground="#fbbf24" FontWeight="Bold" Margin="0,16,0,8"/>
                        <StackPanel Orientation="Horizontal">
                            <Label Content="Scan Interval (hours)"/>
                            <TextBox x:Name="SettingsScanInterval" Width="60" Text="2"/>
                            <Label Content="Daily Brief Time" Margin="16,0,0,0"/>
                            <TextBox x:Name="SettingsBriefTime" Width="80" Text="08:00"/>
                        </StackPanel>
                        <CheckBox x:Name="SettingsAutoStart" Content="Auto-start scheduler on launch"
                                  Margin="0,8,0,0"/>

                        <TextBlock x:Name="SchedulerStatus" Text="" Foreground="#9ca3af"
                                   FontSize="11" Margin="0,8,0,0"/>

                        <Button Content="&#x1F4BE; Save Settings" Click="SaveSettings_Click" Margin="0,16,0,0"
                                Background="#1a3a2a" Foreground="#00ff88" BorderBrush="#00ff88"
                                FontWeight="Bold" HorizontalAlignment="Left" Padding="20,8"/>

                        <!-- Data Management -->
                        <TextBlock Text="DATA MANAGEMENT" Foreground="#fbbf24" FontWeight="Bold" Margin="0,24,0,8"/>
                        <StackPanel Orientation="Horizontal">
                            <Button Content="&#x1F4E4; Export JSON" Click="ExportJson_Click" Margin="0,0,8,0"/>
                            <Button Content="&#x1F4F1; Export Mobile" Click="ExportMobile_Click" Margin="0,0,8,0"/>
                            <Button Content="&#x1F4E5; Import" Click="ImportSentinel_Click"/>
                        </StackPanel>

                        <TextBlock x:Name="SettingsDbPath" Text="" Foreground="#9ca3af"
                                   FontSize="10" Margin="0,16,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- Globe brief selector â€” floats over the tab strip area (top-right), shown only on Globe tab -->
        <Border x:Name="GlobeControlsBar" Grid.Row="1" Panel.ZIndex="10"
                VerticalAlignment="Top" HorizontalAlignment="Right"
                Margin="0,4,12,0" Visibility="Visible"
                Background="#111827" CornerRadius="4" Padding="6,3"
                BorderBrush="#1e293b" BorderThickness="1">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Brief: " Foreground="#9ca3af" FontSize="10"
                           FontFamily="Consolas" VerticalAlignment="Center" Margin="0,0,4,0"/>
                <ComboBox x:Name="GlobeBriefSelector"
                          Background="#111827" Foreground="#e5e7eb"
                          BorderBrush="#374151" FontFamily="Consolas" FontSize="10"
                          Width="240" VerticalAlignment="Center"
                          SelectionChanged="GlobeBriefSelector_Changed"/>
            </StackPanel>
        </Border>

        <!-- ============ STATUS BAR ============ -->
        <Border Grid.Row="2" Background="#111827" BorderBrush="#1e293b" BorderThickness="0,1,0,0">
            <Grid Margin="12,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Image Grid.Column="0" Source="Assets/Sentinel.png" Width="18" Height="18" Margin="0,0,8,0"
                       RenderOptions.BitmapScalingMode="HighQuality" VerticalAlignment="Center"/>
                <TextBlock Grid.Column="1" x:Name="StatusText" Text="Loading..." Foreground="#9ca3af"
                           FontSize="11" VerticalAlignment="Center" FontFamily="Consolas"/>
            </Grid>
        </Border>

        <!-- ============ SCAN PROGRESS BAR (overlays bottom of content area) ============ -->
        <Border x:Name="ScanProgressPanel" Grid.Row="1" VerticalAlignment="Bottom"
                Background="#111827" BorderBrush="#00ff88" BorderThickness="0,1,0,0"
                Height="40" Visibility="Collapsed" Panel.ZIndex="999">
            <Grid Margin="16,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock x:Name="ScanStageText" Grid.Column="0"
                           Text="Initializing scan..."
                           Foreground="#00ff88" FontFamily="Consolas" FontSize="11"
                           VerticalAlignment="Center" Margin="0,0,16,0"/>

                <Border Grid.Column="1" Background="#0a0e17" CornerRadius="4"
                        Height="12" VerticalAlignment="Center">
                    <Border x:Name="ScanProgressFill" Background="#00ff88"
                            CornerRadius="4" HorizontalAlignment="Left" Width="0"/>
                </Border>

                <TextBlock x:Name="ScanProgressPercent" Grid.Column="2"
                           Text="0%" Foreground="#9ca3af" FontFamily="Consolas"
                           FontSize="11" VerticalAlignment="Center" Margin="12,0,0,0"/>
            </Grid>
        </Border>
    </Grid>
</Window>
